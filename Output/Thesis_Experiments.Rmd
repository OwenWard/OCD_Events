---
title: "Thesis Experiments"
author: "Owen G. Ward"
date: "4/18/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.path = "thesis_figure/",
                      dev = "png",
                      fig.height = 5,
                      fig.width = 7)

library(here)
library(tidyverse)
source(here("Experiments/utils.R"))

axis_title <- 16
axis_text_size <- 12
```

# Figures for the Introduction


## Recovering community structure

```{r fig_1_exp_1}
fig_1_files <- list.files(path = here("Experiments/thesis_output/"),
                                      pattern = "fig_1_exp_1")

fig_1_data <- fig_1_files %>% 
  map_dfr(~readRDS(here("Experiments/thesis_output/", .x)))

fig_1_data %>% 
  group_by(Method) %>% 
  summarise(mean(ARI, na.rm = TRUE), sd(ARI, na.rm = TRUE))

# fig_1_data %>% 
#   ggplot(aes(Method, ARI)) +
#   geom_boxplot() +
#   facet_wrap(~Method, scales = "free_x")

method_names <- c("Count", "PZ (window size)", "Point Process")

### want to stratify by window size in PZ also
fig_1 <- fig_1_data %>% 
  mutate(new_x = ifelse(is.na(window_size), " ", window_size)) %>% 
  mutate(new_x = factor(new_x, levels = c(1:10, " "))) %>%
  mutate(Method = if_else(Method == "PZ", "PZ (Window Size)", Method)) %>% 
  mutate(Method = factor(Method,
                         levels = c("Count", "PZ (Window Size)",
                                    "Point Process"))) %>% 
  ggplot(aes(new_x, ARI, fill = Method)) +
  geom_boxplot(alpha = 0.5) +
  facet_wrap(~Method, scales = "free_x") +
  labs(x = element_blank()) +
  theme(legend.position = "none",
        axis.title.y = element_text(size = axis_title),
        strip.text.x = element_text(size = axis_title),
        axis.text = element_text(size = axis_text_size))

fig_1
  
```



## Interpretable Clusters



# Simulation Experiments

## Community Recovery 


### Increasing the number of nodes

We first wish to confirm that we can recover communities when
data is simulated from this model. Here we show community recovery 
for a fixed $K=2, Time = 200$ setting where we increase the number of
nodes from $n=100,200,500,1000$.
With fixed sparsity $\rho = 0.1$. We do this using a fixed 
$n0$, the proportion of
time used for the initialization, 
and $m0$, the number of nodes used for the initialization.

```{r recov-nodes}
## recovery as the number of nodes changes
node_sims <- list.files(path = here("Experiments", "thesis_output"),
                   pattern = "exp_pois_nodes_fixed_april_26_rho_5")
## to be consistent in the sparsity across all the plots,
## rerunning now

node_data <- node_sims %>% 
  map_dfr(~readRDS(here("Experiments/thesis_output/", .x)))
  

node_data %>% 
  filter(init == "Init") %>%
  group_by(nodes, n0, m0) %>% 
  summarise(mean(ARI), sd(ARI))

node_data %>% 
  # group_by(sim, nodes, m0) %>% top_n(1) %>% 
  filter(init == "Init") %>%
  # filter(n0 == 10, m0 == nodes/10) %>%
  ggplot(aes(as.factor(nodes), ARI)) +
  geom_boxplot() +
  labs(x = "Number of Nodes") +
  theme(axis.text = element_text(size = axis_text_size),
        axis.title = element_text(size = axis_title))

## this looks ok now I guess
```


### Increasing the number of communities


```{r pois_k}

## now just one setting for all, in terms of the sparse initialization 
## scheme

K_sims <- list.files(path = here("Experiments", "thesis_output"),
                   pattern = "exp_pois_K_april_25_rho_5")

K_data <- K_sims %>% 
  map_dfr(~readRDS(here("Experiments/thesis_output/", .x)))

K_data %>% 
  filter(init == "Init") %>%
  # filter(nodes == 1000) %>% 
  ggplot(aes(as.factor(K), ARI)) +
  geom_boxplot() +
  ylim(c(0, 1)) +
  # facet_wrap(~nodes) +
  labs(x = "K") +
  theme(axis.text = element_text(size = axis_text_size),
        axis.title = element_text(size = axis_title))

## across multiple community sizes actually looks good too

```

### Online Community Recovery


```{r online_ari}
on_sims <- list.files(path = here("Experiments", "thesis_output"),
                   pattern = "exp_pois_online_april_26")


online_dat <- on_sims %>% 
  map_dfr(~readRDS(here("Experiments/thesis_output/", .x)))

online_dat %>% 
  filter(m0 == nodes/4) %>%
  group_by(time, m0, nodes) %>% 
  summarise(Mean_ARI = mean(ARI), sd = sd(ARI)) %>% 
  mutate(lower = Mean_ARI - sd, upper = min(1, Mean_ARI + sd)) %>% 
  ggplot(aes(time, Mean_ARI, colour = as.factor(nodes))) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  ylim(c(0, 1)) +
  labs(colour = "Number of Nodes", y = "ARI", x = "Time", width = 0.2) +
  # facet_wrap(~nodes) +
  theme(axis.text = element_text(size = axis_text_size),
        axis.title = element_text(size = axis_title),
        legend.text = element_text(size = axis_text_size),
        legend.title = element_text(size = axis_title))
  NULL

## need this to be a bit tidier here, but fine


## Old Experiment 9 also has some interesting experiments
```

## Monitoring Convergence

Variational inference typically looks at the ELBO for this. 
We can also look at some sort of online version of the ELBO here, 
to evaluate convergence of our online estimation procedure.

```{r monitor_conv_dense}

### look at a single sim here first
### use a loss sim here which stores the ELBO

loss_files <- list.files(path = here("Experiments/thesis_output/"), 
                          pattern = "exp_pois_online_loss_april_29")

## how is this normalised? by the cumulative number of events

### try get all of these estimates out at once


elbo_sims <- loss_files %>% 
  map(~read_rds(here("Experiments",
                     "thesis_output",
                     .x))) %>% 
  flatten() %>% 
  imap(~update_list(., sim = .y)) %>% 
  map_dfr(`[`, c("est_elbo", "sim", "Time")) %>% 
  mutate(est_elbo = as.vector(est_elbo)) %>% 
  group_by(sim) %>% mutate(ind = row_number() + 5)

elbo_sims %>% 
  mutate(Time = paste0("Time = ", Time)) %>% 
  ggplot(aes(ind, est_elbo)) +
  geom_line(aes(group = sim), alpha = 0.2) +
  facet_wrap(~Time, scales = "free") +
  labs(x = "Time", y = "ELBO") +
  theme(axis.text = element_text(size = axis_text_size),
        axis.title = element_text(size = axis_title),
        strip.text.x = element_text(size = axis_title))

```

```{r monitor-conv-sparse}
elbo_files <- list.files(path = here("Experiments/thesis_output/"), 
                          pattern = "exp_pois_elbo_april")

elbo_sims <- elbo_files %>% 
  map(~read_rds(here("Experiments",
                     "thesis_output",
                     .x))) %>% 
  flatten() %>% 
  imap(~update_list(., sim = .y)) %>% 
  map_dfr(`[`, c("elbo", "sim", "nodes", "ARI")) %>% 
  mutate(est_elbo = as.vector(elbo)) %>% 
  group_by(sim) %>% mutate(ind = row_number() + 5)

elbo_sims %>% 
  mutate(nodes = paste0("n = ", nodes)) %>% 
  mutate(nodes = factor(nodes, 
                        levels = c("n = 50",
                                   "n = 100",
                                   "n = 200",
                                   "n = 500"))) %>% 
  ggplot(aes(ind, est_elbo)) +
  geom_line(aes(group = sim), alpha = 0.2) +
  # scale_y_continuous(breaks = scales::pretty_breaks(n = 3)) +
  facet_wrap(~nodes) +
  labs(x = "Time", y = "ELBO") +
  theme(axis.text = element_text(size = axis_text_size),
        axis.title = element_text(size = axis_title),
        strip.text.x = element_text(size = axis_title))

## sanity check, this looks the same as the community plot
# elbo_sims %>% 
#   group_by(nodes, sim) %>%
#   summarise(ari = mean(ARI)) %>%
#   ungroup() %>% 
#   ggplot(aes(as.factor(nodes), ari)) +
#   geom_boxplot()

### repeat for fixed number of nodes, varying the length of time 
### observed for 


```


```{r elbo-sparse-time}
elbo_time_files <- list.files(path = here("Experiments/thesis_output/"), 
                          pattern = "exp_pois_elbo_time")

elbo_time_sims <- elbo_time_files %>% 
  map(~read_rds(here("Experiments",
                     "thesis_output",
                     .x))) %>% 
  flatten() %>% 
  imap(~update_list(., sim = .y)) %>% 
  map_dfr(`[`, c("elbo", "sim", "nodes", "ARI", "Time")) %>% 
  mutate(est_elbo = as.vector(elbo)) %>% 
  group_by(sim) %>% 
  mutate(ind = row_number() + 5)

elbo_time_sims %>% 
  mutate(Time = paste0("Time = ", Time)) %>% 
  mutate(Time = factor(Time, levels = c("Time = 50",
                                        "Time = 100",
                                        "Time = 200",
                                        "Time = 500"))) %>% 
  ggplot(aes(ind, est_elbo)) +
  geom_line(aes(group = sim), alpha = 0.2) +
  facet_wrap(~Time, scales = "free") +
  labs(x = "Time", y = "ELBO") +
  theme(axis.text = element_text(size = axis_text_size),
        axis.title = element_text(size = axis_title),
        strip.text.x = element_text(size = axis_title))

```


## Parameter Recovery


```{r param_recov}
param_data <- loss_files %>% 
     map(~read_rds(here("Experiments",
                         "thesis_output",
                         .x))) %>% 
  flatten() %>% 
  imap(~update_list(., sim = .y)) %>% 
  map(`[`, c("sim", "Time", "B_ests", "clust")) %>% 
  imap(~update_list(., sum_B = apply(.x$B, 3, sum))) %>% 
  map_dfr(`[`, c("sum_B","sim", "Time", "clust")) %>% 
  group_by(sim, Time) %>% 
  mutate(index = row_number() + 5)

param_data %>% 
  ### add time here!
  mutate(Time = paste0("Time = ", Time)) %>% 
  mutate(Time = factor(Time, 
                       levels = c("Time = 50",
                                  "Time = 100",
                                  "Time = 200",
                                  "Time = 500"))) %>% 
  # filter(clust == 1) %>% 
  mutate(diff = abs(sum_B - 3.1)/4) %>% 
  ggplot(aes(index, diff)) +
  # geom_line(aes(group = sim), alpha = 0.2) +
  geom_smooth(se = FALSE, method = "loess") +
  facet_wrap(~Time, scales = "free_x") +
  labs(x = "Time", y = "Difference") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  theme(axis.text = element_text(size = axis_text_size),
        axis.title = element_text(size = axis_title),
        strip.text.x = element_text(size = axis_title))

```


## Empirical Regret 

```{r exp_regret}
regret_files <- list.files(path = here("Experiments/thesis_output/"),
                          pattern = "exp_pois_regret_april_30")

# regret_data <- regret_sims %>% 
#   map_dfr(~readRDS(here("Experiments/thesis_output/", .x)))

## look at individual sim


sim_50 <- read_rds(here("Experiments",
                             "thesis_output",
                             regret_files[3])) %>% 
  tibble(
  sim = 1:100,
  ARI = map_dbl(., "clust"),
  regret = map(., "regret"),
  dT = list(6:50)) %>% 
  unnest(cols = c(regret, dT)) %>% 
  select(sim, ARI, regret, dT) %>% 
  mutate(Time = 50)

sim_100 <- read_rds(here("Experiments",
                             "thesis_output",
                             regret_files[1])) %>% 
  tibble(
  sim = 1:100,
  ARI = map_dbl(., "clust"),
  regret = map(., "regret"),
  dT = list(6:100)) %>% 
  unnest(cols = c(regret, dT)) %>% 
  select(sim, ARI, regret, dT) %>% 
  mutate(Time = 100)



sim_200 <- read_rds(here("Experiments",
                             "thesis_output",
                             regret_files[2])) %>% 
  tibble(
  sim = 1:100,
  ARI = map_dbl(., "clust"),
  regret = map(., "regret"),
  dT = list(6:200)) %>% 
  unnest(cols = c(regret, dT)) %>% 
  select(sim, ARI, regret, dT) %>% 
  mutate(Time = 200)

sim_500 <- read_rds(here("Experiments",
                             "thesis_output",
                             regret_files[4])) %>%
  tibble(
  sim = 1:100,
  ARI = map_dbl(., "clust"),
  regret = map(., "regret"),
  dT = list(6:500)) %>%
  unnest(cols = c(regret, dT)) %>%
  select(sim, ARI, regret, dT) %>%
  mutate(Time = 500)

regret_sims <- bind_rows(sim_50,
                         sim_100,
                         sim_200,
                         sim_500)

# regret_sims %>% 
#   filter(ARI == 1) %>%
#   ggplot(aes(dT, regret)) +
#   geom_line(aes(group = sim), alpha = 0.2) +
#   facet_wrap(~Time, scales = "free") +
#   stat_function(fun = function(x) 0.025 * sqrt(x) * log(x*10000)^2,
#                 colour = "red") +
#   labs(y = "Empirical Regret", x = "Time")


### get smoothed regret
regret_sims %>% 
  filter(ARI == 1) %>%
  group_by(Time, dT) %>% 
  # summarise(q_95 = quantile(regret, 0.95)) %>%
  mutate(Time = paste0("Time = ", Time)) %>% 
  mutate(Time = factor(Time, 
                       levels = c("Time = 50", "Time = 100", "Time = 200",
                                  "Time = 500"))) %>% 
  ggplot(aes(dT, regret, colour = Time)) +
  # geom_line(alpha = 0.5) +
  geom_smooth(colour = "black", se = FALSE) +
  facet_wrap(~Time, scales = "free_x") +
  # stat_function(fun = function(x) 0.02 * sqrt(x) * log(x*10000)^2,
  #               colour = "red") +
  labs(y = "Empirical Regret", x = "Time") +
  theme(axis.text = element_text(size = axis_text_size),
        axis.title = element_text(size = axis_title),
        strip.text.x = element_text(size = axis_title))

### maybe without a facet wrap might look better

```

## Online Predictions

```{r online-loss}
loss_files <- list.files(path = here("Experiments/thesis_output/"), 
                          pattern = "exp_pois_online_loss_april_29")

loss_data <- loss_files %>% 
  map(~readRDS(here("Experiments/thesis_output/", .x))) %>% 
  flatten() %>% 
  imap(~update_list(., sim = .y)) %>% 
  map_dfr(`[`, c("online_loss", "batch_ave_loss", "sim", "clust")) %>% 
  reduce(data.frame) %>% 
  as_tibble() %>% 
  rename(Batch_Loss = elt, Sim = elt.1, ARI = elt.2) %>% 
  group_by(Sim) %>% 
  mutate(Time = max(dT)) 


batch_loss <- 
  loss_data %>% 
  group_by(Time) %>% 
  summarise(batch = unique(Batch_Loss)) %>% 
  mutate(Time = paste0("Time = ", Time)) %>% 
  mutate(Time = factor(Time, levels = c("Time = 50",
                                  "Time = 100",
                                  "Time = 200",
                                  "Time = 500")))


loss_data %>% 
  # filter(Sim == 1) %>% 
  filter(Z == "Est_Z") %>% 
  # filter(Time == 200) %>% 
  mutate(Time = paste0("Time = ", Time)) %>% 
  mutate(Time = factor(Time, 
                       levels = c("Time = 50",
                                  "Time = 100",
                                  "Time = 200",
                                  "Time = 500"))) %>% 
  ggplot(aes(dT, Loss)) +
  geom_line(aes(group = interaction(Sim, Z)), alpha = 0.2) +
  geom_hline(data = batch_loss, aes(yintercept =  batch), colour = "red") +
  facet_wrap(~Time, scales = "free_x") +
  labs(x = "Time") +
  theme(legend.position = "null",
        axis.text = element_text(size = axis_text_size),
        axis.title = element_text(size = axis_title),
        strip.text.x = element_text(size = axis_title))

# single_sim <- loss_data %>% 
#   reduce(data.frame) %>% 
#   as_tibble() %>% 
#   rename(Batch_Loss = elt, Sim = elt.1, ARI = elt.2) %>% 
#   filter(Sim == 1) 
# 
# batch_loss = single_sim$Batch_Loss[1]
# 
# single_sim %>% 
#   ggplot(aes(dT, Loss, colour = Z)) +
#   geom_line() +
#   geom_hline(yintercept = batch_loss)

### then just need to add the batch loss across the bottom

```


# Real Data Experiments

## Event Prediction


College Dataset

```{r college-results}
### get the file path
exps <- list.files(path = here("Experiments/thesis_output"),
                   pattern = "College_Link_pred")

pred_data <- exps %>% 
  map_dfr(~readRDS(here("Experiments/thesis_output/", .x)))

pred_data %>% 
  group_by(model) %>% 
  summarise(median(RMSE), sd(RMSE), median(time), sd(time)) 

## this looks fine, just make it into a nice table

```


```{r email-results}
### get the file path
exps <- list.files(path = here("Experiments/thesis_output"),
                   pattern = "Email_Link_pred")

pred_data <- exps %>% 
  map_dfr(~readRDS(here("Experiments/thesis_output/", .x)))

pred_data %>% 
  group_by(model) %>% 
  mutate(RMSE = ifelse(RMSE > 100, 12.9, RMSE)) %>%
  summarise(median(RMSE), mean(time), sd(time))

### need to figure this one out

```

```{r math-link-pred}

exps <- list.files(path = here("Experiments/thesis_output"),
                   pattern = "Math_Link_pred")

pred_data <- exps %>% 
  map_dfr(~readRDS(here("Experiments/thesis_output/", .x)))

pred_data %>% 
  group_by(model) %>% 
  summarise(median(RMSE), median(time), sd(time)) 

```



# Additional Material

## Varying the window size 

We wish to demonstrate that varying the window size used for
processing the data does not have an appreciable effect on 
the performance of our procedure, in terms of community recovery.


```{r window-size-simulations}
### load in and plot some simulations here

wind_files <- list.files(path = here("Experiments/thesis_output"),
                   pattern = "exp_pois_wind")

wind_data <- wind_files %>% 
  map_dfr(~readRDS(here("Experiments/thesis_output/", .x)))
  

wind_data %>% 
  group_by(dT) %>% 
  summarise(mean(clust))

wind_data %>% 
  ggplot(aes(as.factor(dT), clust)) +
  geom_boxplot() +
  ylim(c(0, 1)) +
  labs(x = "Window Size", y = "ARI")

```


```{r hawkes-nodes}
hawkes_files <- list.files(path = here("Experiments/thesis_output"),
                   pattern = "exp_hawkes_new_nodes")


hawkes_sims <- hawkes_files %>% 
  map_dfr(~readRDS(here("Experiments/thesis_output/", .x)))


hawkes_sims %>% 
  ggplot(aes(as.factor(nodes), ARI)) +
  geom_boxplot() +
  labs(x = "Nodes") +
  theme(axis.text = element_text(size = axis_text_size),
        axis.title = element_text(size = axis_title),
        legend.text = element_text(size = axis_text_size),
        legend.title = element_text(size = axis_title))

```


```{r vary-k-hawkes}
hawkes_files <- list.files(path = here("Experiments/thesis_output"),
                   pattern = "exp_hawkes_k")


hawkes_sims <- hawkes_files %>% 
  map_dfr(~readRDS(here("Experiments/thesis_output/", .x)))


hawkes_sims %>% 
  ggplot(aes(as.factor(K), ARI)) +
  geom_boxplot() +
  labs(x = "K") +
  ylim(c(0, 1)) +
  theme(axis.text = element_text(size = axis_text_size),
        axis.title = element_text(size = axis_title),
        legend.text = element_text(size = axis_text_size),
        legend.title = element_text(size = axis_title))

```


```{r hawkes-param}

hawkes_par_files <- list.files(path = here("Experiments/thesis_output"),
                   pattern = "exp_hawkes_param")

hawkes_pars <- hawkes_par_files %>% 
  map(~readRDS(here("Experiments/thesis_output/", .x))) %>% 
  flatten() %>% 
  imap(~update_list(., sim = .y)) %>% 
  map(`[`, c("sim", "Time", "B_ests", "clust", "Mu_ests", "lambda")) %>% 
  imap(~update_list(., sum_B = apply(.x$B_ests, 3, sum),
                       sum_Mu = apply(.x$Mu_ests, 3, sum))) %>% 
  map_dfr(`[`, c("sim", "Time", "clust", "sum_Mu", "sum_B", "lambda"))


names <- colnames(hawkes_pars)

new_hawkes <- hawkes_pars %>% 
  reduce(data.frame) %>% as_tibble()

colnames(new_hawkes) <- names

new_hawkes %>% 
  rename(lam_est = lambda) %>% 
  group_by(sim, Time) %>% 
  mutate(index = row_number()) %>% 
  ### add time here!
  mutate(Time = paste0("Time = ", Time)) %>% 
  mutate(Time = factor(Time, 
                       levels = c("Time = 50",
                                  "Time = 100",
                                  "Time = 200",
                                  "Time = 500"))) %>% 
  mutate(Mu = abs(sum_Mu - 3.65)/4,
         B = abs(sum_B - 1)/4,
         lambda = abs(lam_est - 1)) %>% 
  pivot_longer(cols = Mu:lambda, names_to = "Parameter",
               values_to = "diff") %>% 
  filter(clust == 1) %>% 
  ggplot(aes(index, diff, colour = Parameter)) +
  geom_smooth(se = FALSE, method = "loess") +
  # geom_line(aes(group = interaction(sim, param)), alpha = 0.2) +
  facet_wrap(~Time, scales = "free_x") +
  labs(x = "Time", y = "Difference") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  scale_fill_discrete(name = "Parameter") +
  theme(axis.text = element_text(size = axis_text_size),
        axis.title = element_text(size = axis_title),
        legend.text = element_text(size = axis_text_size),
        legend.title = element_text(size = axis_title))
```


```{r hawkes-online-community}
### check online commuity recovery

hawkes_files <- list.files(path = here("Experiments/thesis_output"),
                   pattern = "exp_hawkes_online")

hawkes_data <- hawkes_files %>% 
  map_dfr(~readRDS(here("Experiments/thesis_output/", .x)))

# hawkes_data %>% 
#   group_by(sim) %>% 
#   mutate(final_ari = max(ARI)) %>% 
#   filter(final_ari == 1) %>% 
#   ggplot(aes(time, ARI)) +
#   geom_line(aes(group = sim))


## match above plot
hawkes_data %>% 
  group_by(time, nodes) %>% 
  summarise(mean_ARI = mean(ARI), sd_ARI = sd(ARI)) %>% 
  group_by(time) %>% 
  mutate(lower = max(0, mean_ARI - sd_ARI),
         upper = min(1, mean_ARI + sd_ARI)) %>% 
  ggplot(aes(time, mean_ARI)) +
  geom_line() +
  geom_errorbar(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  ylim(c(0, 1)) +
  labs(colour = "Number of Nodes", y = "ARI", x = "Time", width = 0.2) +
  facet_wrap(~nodes) +
  theme(axis.text = element_text(size = axis_text_size),
        axis.title = element_text(size = axis_title),
        legend.text = element_text(size = axis_text_size),
        legend.title = element_text(size = axis_title)) +
  NULL

## do this via colour instead?
## also need to rerun to match the simulation settings for the rest
```
